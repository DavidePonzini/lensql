services:
  webui:
    build: ./webui
    image: davideponzini/lensql:webui
    container_name: lensql_webui
    restart: unless-stopped
    ports:
      - "3000:3000"
    develop:
      watch: 
        - path: ./webui
          action: rebuild

  server:
    build: ./server
    image: davideponzini/lensql:server
    container_name: lensql_server
    restart: unless-stopped
    depends_on:
      - db_admin
      - db_users
    environment:
      - DB_HOST=db_admin
      - DB_PORT=5432
      - DB_USERNAME=postgres
      - DB_PASSWORD=password
      - DB_NAME=postgres
      - USER_DB_HOST=db_users
      - USER_DB_PORT=5432
      - MAX_CONNECTION_HOURS=4
      - CLEANUP_INTERVAL_SECONDS=3600
    env_file:
      - server/.env
    develop:
      watch:
        - path: ./server
          action: rebuild

  nginx:
    build: ./nginx
    image: davideponzini/lensql:nginx
    container_name: lensql_nginx
    restart: unless-stopped
    ports:
      - "3001:80"
      - "3002:443"
    depends_on:
      - webui
      - server
    develop:
      watch:
        - path: ./nginx
          action: rebuild

  db_admin:
    build: ./db_admin
    image: davideponzini/lensql:db_admin
    container_name: lensql_db_admin
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: password
    volumes:
      - lensql_pgdata:/var/lib/postgresql/data
    develop:
      watch:
        - path: ./db_admin
          action: rebuild

  db_users:
    image: postgres:latest
    command: -c 'max_connections=500'
    container_name: lensql_db_users
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - lensql_pgdata_users:/var/lib/postgresql/data

volumes:
  lensql_pgdata:
  lensql_pgdata_users:
